<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>starlight í¬ë ˆë”§ ê²°ì œí•˜ê¸° (Popup + postMessage)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Toss v2 Standard SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <style>
        :root { font-family: system-ui, -apple-system, "Noto Sans KR", Roboto, Arial, sans-serif; }
        body { margin:0; padding:24px; background:#0b0c10; color:#e8e8e8; }
        .container { max-width:720px; margin:0 auto; background:#111318; border:1px solid #1f2430; border-radius:16px; padding:24px; }
        h1 { margin:0 0 8px; font-size:22px; }
        p  { margin:0 0 16px; color:#b8c0cc; }
        .row { display:flex; gap:10px; margin-bottom:12px; }
        .btn { padding:12px 14px; border-radius:10px; border:1px solid #293140; background:#171c25; color:#e8e8e8; cursor:pointer; font-weight:600; text-align:center; }
        .btn:hover { background:#1b222d; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .field { width:100%; padding:14px; border-radius:10px; border:1px solid #293140; background:#0f141c; color:#e8e8e8; font-size:16px; }
        .result { margin-top:14px; padding:12px; border-radius:10px; background:#0f141c; border:1px solid #1f2430; display:none; white-space:pre-wrap; }
        .ok { border-color:#1f6c2a; }
        .err{ border-color:#7a1d1d; }
        .loading { display:inline-block; width:16px; height:16px; border:2px solid #e8e8e8; border-top-color:transparent; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <h1>starlight í¬ë ˆë”§ ê²°ì œí•˜ê¸°</h1>
    <p>íŒì—…ì—ì„œ ê²°ì œ í›„, ì„±ê³µ/ì‹¤íŒ¨ë¥¼ <b>postMessage</b>ë¡œ ë°›ì•„ í‘œì‹œí•©ë‹ˆë‹¤.</p>

    <div class="row">
        <button class="btn amt" data-amt="1000">1,000ì›</button>
        <button class="btn amt" data-amt="5000">5,000ì›</button>
        <button class="btn amt" data-amt="10000">10,000ì›</button>
        <input id="amount" class="field" type="number" min="100" step="100" placeholder="ì§ì ‘ ì…ë ¥ (ì˜ˆ: 3000) â€” ì›" />
    </div>

    <div class="row"><input id="buyerName"  class="field" placeholder="ì´ë¦„ (ì„ íƒ)" /></div>
    <div class="row"><input id="buyerEmail" class="field" placeholder="ì´ë©”ì¼ (ì„ íƒ)" /></div>

    <div class="row">
        <button id="payCard"      class="btn" style="flex:1">ì¹´ë“œ ê²°ì œ</button>
        <button id="payTossEasy"  class="btn" style="flex:1">í† ìŠ¤í˜ì´(ê°„í¸)</button>
        <button id="payKakaoEasy" class="btn" style="flex:1">ì¹´ì¹´ì˜¤í˜ì´(ê°„í¸)</button>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
    // ===== ìœ í‹¸ =====
    function genOrderCode() {
        const d = new Date();
        return 'ORD' + d.getFullYear()
            + String(d.getMonth()+1).padStart(2,'0')
            + String(d.getDate()).padStart(2,'0')
            + '-' + Math.random().toString(36).slice(2,10).toUpperCase();
    }
    function getAmount() { return Number(document.getElementById('amount').value || 0); }
    function out() { const el=document.getElementById('result'); el.style.display='block'; return el; }
    function stamp(){ return `[${new Date().toLocaleString()}]\n`; }
    function showOk(t){ const el=out(); el.classList.remove('err'); el.classList.add('ok'); el.textContent=stamp()+t; }
    function showErr(t){ const el=out(); el.classList.remove('ok'); el.classList.add('err'); el.textContent=stamp()+t; }

    // ë²„íŠ¼ ë¹„í™œì„±í™”/í™œì„±í™”
    function disableButtons() {
        document.querySelectorAll('.btn').forEach(b => b.disabled = true);
    }
    function enableButtons() {
        document.querySelectorAll('.btn').forEach(b => b.disabled = false);
    }

    document.querySelectorAll('.btn.amt').forEach(b=>{
        b.addEventListener('click', ()=> document.getElementById('amount').value = b.dataset.amt);
    });

    (async () => {
        try {
            // v2 Standard ì´ˆê¸°í™” (ë¹„íšŒì› ê²°ì œ)
            const toss = TossPayments("test_ck_0RnYX2w532eMEymGdQeK8NeyqApQ");
            const payment = toss.payment({ customerKey: TossPayments.ANONYMOUS });

            // íŒì—…ì—ì„œ postMessageë¡œ ê²°ê³¼ ë°›ê¸°
            window.addEventListener('message', (e) => {
                if (e.origin !== location.origin) return; // ë³´ì•ˆ
                const d = e.data || {};

                if (d.type === 'TOSS_SUCCESS') {
                    showOk(
                        `âœ… ê²°ì œ ì„±ê³µ!\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${d.orderId}\n` +
                        `ê¸ˆì•¡: ${d.amount?.toLocaleString()}ì›\n` +
                        `ê²°ì œìˆ˜ë‹¨: ${d.method || '-'}\n` +
                        `ê°„í¸ê²°ì œ: ${d.provider || '-'}\n` +
                        `ì˜ìˆ˜ì¦: ${d.receiptUrl || '-'}\n` +
                        `ìŠ¹ì¸ì‹œê°: ${d.approvedAt ? new Date(d.approvedAt).toLocaleString() : '-'}`
                    );
                    enableButtons();
                } else if (d.type === 'TOSS_FAIL') {
                    showErr(
                        `âŒ ê²°ì œ ì‹¤íŒ¨\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${d.orderId}\n` +
                        `ì—ëŸ¬ì½”ë“œ: ${d.code}\n` +
                        `ë©”ì‹œì§€: ${d.message}`
                    );
                    enableButtons();
                }
            });

            function toAbsolute(url) {
                return url.startsWith('http') ? url : (location.origin + url);
            }

            async function start({ method }) {
                try {
                    const value = getAmount();
                    if (!Number.isFinite(value) || value <= 0) {
                        showErr('âŒ ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');
                        return;
                    }
                    if (method === 'EASY_PAY' && value < 1000) {
                        showErr('âŒ ê°„í¸ê²°ì œëŠ” 1,000ì› ì´ìƒì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.');
                        return;
                    }

                    disableButtons();
                    showOk('â³ ì£¼ë¬¸ ìƒì„± ì¤‘...');

                    const orderCode = genOrderCode();
                    const orderName = `starlight í¬ë ˆë”§ ${value.toLocaleString()}ì›`;

                    // 1. ë°±ì—”ë“œ ì£¼ë¬¸ ìƒì„± (POST /api/toss/request)
                    const prepareResponse = await fetch(`${location.origin}/api/toss/request`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderCode: orderCode,
                            price: value,
                            buyerId: 1,
                            businessPlanId: 2
                        })
                    });

                    if (!prepareResponse.ok) {
                        const errorData = await prepareResponse.json();
                        throw new Error(errorData.message || 'ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨');
                    }

                    const prepareData = await prepareResponse.json();
                    console.log('âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ:', prepareData);

                    showOk('ğŸš€ ê²°ì œì°½ í˜¸ì¶œ ì¤‘...');

                    // 2. í† ìŠ¤ ê²°ì œì°½ í˜¸ì¶œ
                    const paymentRequest = {
                        method: method,
                        amount: { currency: 'KRW', value },
                        orderId: orderCode,
                        orderName,
                        successUrl: toAbsolute("/toss/popup.html"),
                        failUrl: toAbsolute("/toss/popup.html"),
                        customerEmail: document.getElementById('buyerEmail').value || undefined,
                        customerName: document.getElementById('buyerName').value || undefined,
                    };

                    await payment.requestPayment(paymentRequest);

                } catch (e) {
                    console.error('ê²°ì œ ì²˜ë¦¬ ì—ëŸ¬:', e);
                    const code = e?.code ? ` [${e.code}]` : '';
                    showErr(
                        `âŒ ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨\n\n` +
                        `ì—ëŸ¬: ${e.message || e}${code}`
                    );
                    enableButtons();
                }
            }

            // ê²°ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('payCard')
                .addEventListener('click', ()=> start({ method:'CARD' }));

            document.getElementById('payTossEasy')
                .addEventListener('click', ()=> start({ method:'EASY_PAY' }));

            document.getElementById('payKakaoEasy')
                .addEventListener('click', ()=> start({ method:'EASY_PAY' }));

            // (ë¦¬ë‹¤ì´ë ‰íŠ¸ í´ë°±) íŒì—… ì°¨ë‹¨ ì‹œ í˜„ì¬ íƒ­ìœ¼ë¡œ ëŒì•„ì˜¨ ê²½ìš°
            (function fallbackFromQuery(){
                const p = new URLSearchParams(location.search);
                if (!p.has('status')) return;

                if (p.get('status') === 'success') {
                    showOk(
                        `âœ… ê²°ì œ ì„±ê³µ (í´ë°±)\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${p.get('orderId')}\n` +
                        `ê¸ˆì•¡: ${p.get('amount')}`
                    );
                } else {
                    showErr(
                        `âŒ ê²°ì œ ì‹¤íŒ¨ (í´ë°±)\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${p.get('orderId')}\n` +
                        `ì½”ë“œ: ${p.get('code')}\n` +
                        `ë©”ì‹œì§€: ${p.get('message')}`
                    );
                }
                history.replaceState(null, '', location.pathname);
            })();

        } catch (e) {
            console.error('SDK ì´ˆê¸°í™” ì—ëŸ¬:', e);
            showErr('âŒ í† ìŠ¤í˜ì´ë¨¼ì¸  SDKë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    })();
</script>
</body>
</html>