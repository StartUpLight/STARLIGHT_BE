<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>starlight í¬ë ˆë”§ ê²°ì œí•˜ê¸° (Popup + postMessage)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Toss v2 Standard SDK -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <style>
        :root { font-family: system-ui, -apple-system, "Noto Sans KR", Roboto, Arial, sans-serif; }
        body { margin:0; padding:24px; background:#0b0c10; color:#e8e8e8; }
        .container { max-width:720px; margin:0 auto; background:#111318; border:1px solid #1f2430; border-radius:16px; padding:24px; }
        h1 { margin:0 0 8px; font-size:22px; }
        p  { margin:0 0 16px; color:#b8c0cc; }
        .row { display:flex; gap:10px; margin-bottom:12px; }
        .btn { padding:12px 14px; border-radius:10px; border:1px solid #293140; background:#171c25; color:#e8e8e8; cursor:pointer; font-weight:600; text-align:center; }
        .btn:hover { background:#1b222d; }
        .btn:disabled { opacity:0.5; cursor:not-allowed; }
        .btn.product.active {
            border-color:#4f46e5;
            background:#1f2937;
        }
        .field { width:100%; padding:14px; border-radius:10px; border:1px solid #293140; background:#0f141c; color:#e8e8e8; font-size:16px; }
        .result { margin-top:14px; padding:12px; border-radius:10px; background:#0f141c; border:1px solid #1f2430; display:none; white-space:pre-wrap; }
        .ok { border-color:#1f6c2a; }
        .err{ border-color:#7a1d1d; }
        .loading { display:inline-block; width:16px; height:16px; border:2px solid #e8e8e8; border-top-color:transparent; border-radius:50%; animation:spin 0.6s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <h1>starlight í¬ë ˆë”§ ê²°ì œí•˜ê¸°</h1>
    <p>ìƒí’ˆ(ì´ìš©ê¶Œ)ì„ ì„ íƒí•˜ê³ , íŒì—…ì—ì„œ ê²°ì œ í›„ <b>postMessage</b>ë¡œ ê²°ê³¼ë¥¼ ë°›ìŠµë‹ˆë‹¤.</p>

    <!-- ìƒí’ˆ ì„ íƒ: AI_REPORT_1, AI_REPORT_2 -->
    <div class="row">
        <button
                class="btn product"
                data-product-code="AI_REPORT_1"
                data-product-name="AI ë¦¬í¬íŠ¸ 1íšŒê¶Œ"
        >
            AI ë¦¬í¬íŠ¸ 1íšŒê¶Œ (69,000ì›)
        </button>
        <button
                class="btn product"
                data-product-code="AI_REPORT_2"
                data-product-name="AI ë¦¬í¬íŠ¸ 2íšŒê¶Œ"
        >
            AI ë¦¬í¬íŠ¸ 2íšŒê¶Œ (99,000ì›)
        </button>
    </div>

    <div class="row"><input id="buyerName"  class="field" placeholder="ì´ë¦„ (ì„ íƒ)" /></div>
    <div class="row"><input id="buyerEmail" class="field" placeholder="ì´ë©”ì¼ (ì„ íƒ)" /></div>

    <div class="row">
        <button id="payCard"      class="btn" style="flex:1">ì¹´ë“œ ê²°ì œ</button>
        <button id="payTossEasy"  class="btn" style="flex:1">í† ìŠ¤í˜ì´(ê°„í¸)</button>
        <button id="payKakaoEasy" class="btn" style="flex:1">ì¹´ì¹´ì˜¤í˜ì´(ê°„í¸)</button>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
    // ===== ìœ í‹¸ =====
    function genOrderCode() {
        const d = new Date();
        return 'ORD' + d.getFullYear()
            + String(d.getMonth()+1).padStart(2,'0')
            + String(d.getDate()).padStart(2,'0')
            + '-' + Math.random().toString(36).slice(2,10).toUpperCase();
    }
    function out() { const el=document.getElementById('result'); el.style.display='block'; return el; }
    function stamp(){ return `[${new Date().toLocaleString()}]\n`; }
    function showOk(t){ const el=out(); el.classList.remove('err'); el.classList.add('ok'); el.textContent=stamp()+t; }
    function showErr(t){ const el=out(); el.classList.remove('ok'); el.classList.add('err'); el.textContent=stamp()+t; }

    function disableButtons() { document.querySelectorAll('.btn').forEach(b => b.disabled = true); }
    function enableButtons() { document.querySelectorAll('.btn').forEach(b => b.disabled = false); }

    (async () => {
        let selectedProduct = null; // { code, name }

        // ìƒí’ˆ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
        document.querySelectorAll('.btn.product').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn.product').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                selectedProduct = {
                    code: btn.dataset.productCode,
                    name: btn.dataset.productName
                };
            });
        });

        try {
            // v2 Standard ì´ˆê¸°í™” (ë¹„íšŒì› ê²°ì œ)
            const toss = TossPayments("test_ck_0RnYX2w532eMEymGdQeK8NeyqApQ");
            const payment = toss.payment({ customerKey: TossPayments.ANONYMOUS });

            // íŒì—…ì—ì„œ postMessageë¡œ ê²°ê³¼ ë°›ê¸°
            window.addEventListener('message', (e) => {
                if (e.origin !== location.origin) return; // ë³´ì•ˆ
                const d = e.data || {};

                if (d.type === 'TOSS_SUCCESS') {
                    showOk(
                        `âœ… ê²°ì œ ì„±ê³µ!\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${d.orderId}\n` +
                        `ê¸ˆì•¡: ${d.amount?.toLocaleString()}ì›\n` +
                        `ê²°ì œìˆ˜ë‹¨: ${d.method || '-'}\n` +
                        `ê°„í¸ê²°ì œ: ${d.provider || '-'}\n` +
                        `ì˜ìˆ˜ì¦: ${d.receiptUrl || '-'}\n` +
                        `ìŠ¹ì¸ì‹œê°: ${d.approvedAt ? new Date(d.approvedAt).toLocaleString() : '-'}`
                    );
                    enableButtons();
                } else if (d.type === 'TOSS_FAIL') {
                    showErr(
                        `âŒ ê²°ì œ ì‹¤íŒ¨\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${d.orderId}\n` +
                        `ì—ëŸ¬ì½”ë“œ: ${d.code}\n` +
                        `ë©”ì‹œì§€: ${d.message}`
                    );
                    enableButtons();
                }
            });

            function toAbsolute(url) {
                return url.startsWith('http') ? url : (location.origin + url);
            }

            async function start({ method }) {
                try {
                    if (!selectedProduct) {
                        showErr('âŒ ë¨¼ì € ìƒí’ˆ(ì´ìš©ê¶Œ)ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                        return;
                    }

                    disableButtons();
                    showOk('â³ ì£¼ë¬¸ ìƒì„± ì¤‘...');

                    const orderCode = genOrderCode();

                    // 1. ë°±ì—”ë“œ ì£¼ë¬¸ ìƒì„± (POST /api/toss/request)
                    //    ìš”ì²­: productCode ê¸°ë°˜
                    const prepareResponse = await fetch(`${location.origin}/api/toss/request`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            orderCode: orderCode,
                            buyerId: 1,          // TODO: ì‹¤ì œ ë¡œê·¸ì¸ ìœ ì € IDë¡œ êµì²´
                            productCode: selectedProduct.code // "AI_REPORT_1" / "AI_REPORT_2"
                        })
                    });

                    if (!prepareResponse.ok) {
                        let msg = 'ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨';
                        try {
                            const errorData = await prepareResponse.json();
                            msg = errorData.message || msg;
                        } catch (_) {}
                        throw new Error(msg);
                    }

                    const prepareJson = await prepareResponse.json();
                    console.log('âœ… ì£¼ë¬¸ ìƒì„± ì™„ë£Œ:', prepareJson);

                    // ApiResponse í˜•íƒœ: { result: 'SUCCESS', data: { ... }, error: ... }
                    const data = prepareJson.data ?? prepareJson;

                    // ë°±ì—”ë“œê°€ ëŒë ¤ì£¼ëŠ” í•„ë“œëª… ë§ì¶”ê¸°
                    // ì§€ê¸ˆì€ data.amount ë¡œ ì˜¤ê³  ìˆìŒ
                    const amount = (typeof data.amount === 'number' ? data.amount : data.price);
                    const currency = data.currency || 'KRW';   // ì„œë²„ì—ì„œ ì•ˆ ì£¼ë©´ ì¼ë‹¨ KRWë¡œ ê³ ì •
                    const orderId = data.orderCode || data.orderId || orderCode;
                    const orderName = data.orderName || selectedProduct.name;

                    if (!Number.isFinite(amount) || amount <= 0) {
                        throw new Error('ì„œë²„ì—ì„œ ê¸ˆì•¡ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }


                    showOk('ğŸš€ ê²°ì œì°½ í˜¸ì¶œ ì¤‘...');

                    // 2. í† ìŠ¤ ê²°ì œì°½ í˜¸ì¶œ
                    const paymentRequest = {
                        method: method,
                        amount: { currency, value: amount },
                        orderId: orderId,
                        orderName: orderName,
                        successUrl: toAbsolute("/toss/popup.html"),
                        failUrl: toAbsolute("/toss/popup.html"),
                        customerEmail: document.getElementById('buyerEmail').value || undefined,
                        customerName: document.getElementById('buyerName').value || undefined,
                    };

                    await payment.requestPayment(paymentRequest);

                } catch (e) {
                    console.error('ê²°ì œ ì²˜ë¦¬ ì—ëŸ¬:', e);
                    const code = e?.code ? ` [${e.code}]` : '';
                    showErr(
                        `âŒ ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨\n\n` +
                        `ì—ëŸ¬: ${e.message || e}${code}`
                    );
                    enableButtons();
                }
            }

            // ê²°ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('payCard')
                .addEventListener('click', ()=> start({ method:'CARD' }));
            document.getElementById('payTossEasy')
                .addEventListener('click', ()=> start({ method:'EASY_PAY' }));
            document.getElementById('payKakaoEasy')
                .addEventListener('click', ()=> start({ method:'EASY_PAY' }));

            // (ë¦¬ë‹¤ì´ë ‰íŠ¸ í´ë°±) íŒì—… ì°¨ë‹¨ ì‹œ í˜„ì¬ íƒ­ìœ¼ë¡œ ëŒì•„ì˜¨ ê²½ìš°
            (function fallbackFromQuery(){
                const p = new URLSearchParams(location.search);
                if (!p.has('status')) return;

                if (p.get('status') === 'success') {
                    showOk(
                        `âœ… ê²°ì œ ì„±ê³µ (í´ë°±)\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${p.get('orderId')}\n` +
                        `ê¸ˆì•¡: ${p.get('amount')}`
                    );
                } else {
                    showErr(
                        `âŒ ê²°ì œ ì‹¤íŒ¨ (í´ë°±)\n\n` +
                        `ì£¼ë¬¸ë²ˆí˜¸: ${p.get('orderId')}\n` +
                        `ì½”ë“œ: ${p.get('code')}\n` +
                        `ë©”ì‹œì§€: ${p.get('message')}`
                    );
                }
                history.replaceState(null, '', location.pathname);
            })();

        } catch (e) {
            console.error('SDK ì´ˆê¸°í™” ì—ëŸ¬:', e);
            showErr('âŒ í† ìŠ¤í˜ì´ë¨¼ì¸  SDKë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.');
        }
    })();
</script>
</body>
</html>
