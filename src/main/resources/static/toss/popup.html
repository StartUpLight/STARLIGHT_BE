<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>결제 처리 중...</title>
    <style>
        :root { font-family: system-ui, -apple-system, "Noto Sans KR", Roboto, Arial, sans-serif; }
        body {
            margin:0; padding:0;
            background:#0b0c10; color:#e8e8e8;
            display:flex; align-items:center; justify-content:center;
            min-height:100vh;
        }
        .container {
            text-align:center;
            max-width:480px;
            padding:32px;
            background:#111318;
            border:1px solid #1f2430;
            border-radius:16px;
        }
        h1 { margin:0 0 16px; font-size:24px; }
        .loading {
            display:inline-block;
            width:40px; height:40px;
            border:4px solid #293140;
            border-top-color:#7c3aed;
            border-radius:50%;
            animation:spin 0.8s linear infinite;
            margin:20px 0;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        .status {
            margin-top:16px;
            padding:12px;
            border-radius:8px;
            background:#1f2430;
            font-size:14px;
            color:#b8c0cc;
        }
        .error { background:#3a1a1a; color:#ff6b6b; }
        .success { background:#1a3a1f; color:#51cf66; }
    </style>
</head>
<body>
<div class="container">
    <h1 id="title">결제 확인 중...</h1>
    <div class="loading" id="spinner"></div>
    <div class="status" id="status">잠시만 기다려주세요.</div>
</div>

<script>
    const params = new URLSearchParams(location.search);
    const orderId = params.get('orderId');
    const paymentKey = params.get('paymentKey');
    const amount = params.get('amount');
    const code = params.get('code');
    const message = params.get('message');

    const $title = document.getElementById('title');
    const $status = document.getElementById('status');
    const $spinner = document.getElementById('spinner');

    function updateUI(title, status, isError = false) {
        $title.textContent = title;
        $status.textContent = status;
        $spinner.style.display = 'none';
        if (isError) {
            $status.classList.add('error');
        } else {
            $status.classList.add('success');
        }
    }

    // 성공 케이스: paymentKey 있음
    if (paymentKey && orderId && amount) {
        (async () => {
            try {
                $status.textContent = '결제 승인 요청 중...';

                // 백엔드 승인 API 호출
                const response = await fetch(`${location.origin}/api/toss/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderCode: orderId,
                        paymentKey: paymentKey,
                        price: Number(amount)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '승인 실패');
                }

                const data = await response.json();
                console.log('✅ 결제 승인 완료:', data);

                updateUI('✅ 결제 완료!', '결제가 성공적으로 완료되었습니다.');

                // 부모 창에 성공 메시지 전송
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'TOSS_SUCCESS',
                        orderId: data.result.orderId,
                        amount: data.result.amount,
                        method: data.result.method,
                        provider: data.result.provider,
                        receiptUrl: data.result.receiptUrl,
                        approvedAt: data.result.approvedAt
                    }, location.origin);

                    setTimeout(() => window.close(), 1500);
                } else {
                    $status.textContent = '결제 완료! (3초 후 메인 페이지로 이동)';
                    setTimeout(() => {
                        location.href = '/payment.html?status=success&orderId=' + orderId + '&amount=' + amount;
                    }, 3000);
                }

            } catch (error) {
                console.error('승인 에러:', error);
                updateUI('❌ 결제 승인 실패', error.message || '알 수 없는 오류', true);

                if (window.opener) {
                    window.opener.postMessage({
                        type: 'TOSS_FAIL',
                        orderId: orderId,
                        code: 'CONFIRM_ERROR',
                        message: error.message
                    }, location.origin);

                    setTimeout(() => window.close(), 3000);
                }
            }
        })();
    }
    // 실패 케이스: code, message 있음
    else if (code && message) {
        updateUI('❌ 결제 실패', `${code}: ${decodeURIComponent(message)}`, true);

        if (window.opener) {
            window.opener.postMessage({
                type: 'TOSS_FAIL',
                orderId: orderId || 'UNKNOWN',
                code: code,
                message: decodeURIComponent(message)
            }, location.origin);

            setTimeout(() => window.close(), 3000);
        } else {
            setTimeout(() => {
                location.href = '/payment.html?status=fail&orderId=' + (orderId || '') + '&code=' + code + '&message=' + message;
            }, 3000);
        }
    }
    // 잘못된 접근
    else {
        updateUI('⚠️ 잘못된 접근', '올바르지 않은 요청입니다.', true);
        setTimeout(() => {
            if (window.opener) {
                window.close();
            } else {
                location.href = '/payment.html';
            }
        }, 2000);
    }
</script>
</body>
</html>